# アセンブラとリンカとオブジェクトファイル

## `(d16,An)`が意図しないディスプレースメントになる問題

a.s
```m68k
.xref X
  move.l #$deadbeef,(buf+X)

  lea (buf,pc),a0
  move.l (X,a0),d0
  .dc $ff00

.bss
buf: .ds.b $10000
```

b.s
```m68k
.offset 0
    .ds.b $8000
X:: .ds.l 1
```

アセンブラで警告が出ず、リンカでもエラーにならないため意図しない動作になる。

オブジェクトファイルのコマンドでワード値の出力時に`-$8000～$7fff`の範囲外の値をエラーにするものは次のものしかない。
* `65 sect.b`
* `69 sect.b`
* `99 00`

`d16`の出力を`99 00`を使うように変更する(スタックからポップするコマンドなので値のプッシュも必要)
という手段が考えられる。


## `(d8,An,Ix)`が意図しないディスプレースメントになる問題

a.s
```m68k
.xref X
  move.l #$deadbeef,(buf+X+4)

  lea (buf,pc),a0
  moveq #4,d0
  move.l (X,a0,d0.l),d0
  .dc $ff00

.bss
buf: .ds.b $10000
```

b.s
```m68k
.offset 0
    .ds.b $80
X:: .ds.l 2
```

アセンブラで警告が出ず、リンカでもエラーにならないため意図しない動作になる。

`-$80～$7f`の範囲外の値をエラーにするものは`6b sect.b`しかない。  
コマンドを新設する必要がある？


## `bra.s`のディスプレースメントが`$00`になる問題

a.s
```m68k
  .xref Foo
  bra.s Foo
```

b.s
```m68k
.include doscall.mac

; nop
Foo::
  DOS _KEYSNS
  DOS _EXIT
```

`hlkx a.o b.o`としてリンクすると`bra.s Foo`が`$60 00`になり、
次の1ワードを16ビットディスプレースメントとして読み込んでしまう。  
コメントしてある`nop`を有効にすれば問題ないコードが出力される。

実際に問題になることはまずないと思うが、アセンブラで警告が出ず、リンカでもエラーにならない。


----
goto [index](../README.md) / [プログラミング](./README.md)
