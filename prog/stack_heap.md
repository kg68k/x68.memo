# スタックサイズとヒープサイズの指定

## XCでスタックとヒープサイズを指定する仕組み

XCでは`main()`関数を含むファイルのコンパイル時に、
オプション指定でスタックサイズやヒープサイズを指定できます。
* `/Gs<n>` ... スタックサイズ(`<n>`はバイト数、末尾に`k`を付けるとキビバイト単位)
* `/Gh<n>` ... ヒープサイズ(`<n>`はバイト数、末尾に`k`を付けるとキビバイト単位)

例えばこのようなアセンブラソースファイルが出力されます(主要部分のみ)。
```
        .GLOBL  _main
        .XDEF   _STACK_SIZE
_STACK_SIZE     EQU     1230
        .XDEF   _HEAP_SIZE
_HEAP_SIZE      EQU     4560
        .XREF   __main
        .TEXT
_main:
        LINK    A6,#0
        MOVEQ.L #0,D0
        UNLK    A6
        RTS
```

オプションを指定しない場合は`_STACK_SIZE`や`_HEAP_SIZE`の定義は出力されません。
また、オプションを指定しても`main()`関数を含まないファイルでは出力されません。

これらのシンボルは、CLIB.Lに含まれている\_\_MAIN.Oファイルから参照されています。
```
__STACK:        dc.l    _STACK_SIZE
__HEAP:         dc.l    _HEAP_SIZE
```

サイズが格納された`__STACK`や`__HEAP`をスタートアップルーチンが参照して、
動的にスタックやヒープが設定されます。

さて、オプションを指定せず`_STACK_SIZE`や`_HEAP_SIZE`が定義されなかった場合は
どうなるでしょうか。

CLIB.Lに含まれている\_DEDFSTK.Oにて標準のスタックサイズが定義されています。
```
_STACK_SIZE     equ     65536           . スタック・サイズ
```
同じく\_DEDFHEAP.Oに標準のヒープサイズが定義されています。
```
_HEAP_SIZE      equ     65536           . ヒープ領域サイズ
```

リンカは、リンクするオブジェクトファイル中に参照されているシンボルが見つからなかった場合、
アーカイブ(\*.a)やライブラリ(\*.l)に含まれるオブジェクトファイルからシンボルを探しますので、
`_STACK_SIZE`や`_HEAP_SIZE`が定義されなかった場合はCLIB.L内のこれらのオブジェクトファイルが
リンクされます。


### (XC) シンボル定義によるスタックとヒープサイズの指定

リンク時に規定のシンボルが定義されていればよいので、例えば
```
.xdef _STACK_SIZE
_STACK_SIZE: .equ 32768
```
といったファイルをアセンブルし、一緒にリンクさせるといった方法でも指定できます。


### (XC) ファイル実行時のスタックとヒープサイズの指定

XCライブラリがリンクされた実行ファイルは、実行時にコマンドライン引数で
オプションを指定すればスタックサイズ、ヒープサイズを指定できます。
* `/stack:<n>` ... スタックサイズ(`<n>`はバイト数、末尾に`k`を付けるとキビバイト単位)
* `/heap:<n>` ... ヒープサイズ(`<n>`はバイト数、末尾に`k`を付けるとキビバイト単位)


## 真里子版GCCでスタックとヒープサイズを指定する仕組み

真里子版GCCでは実行ファイルの生成時に
オプション指定でスタックサイズやヒープサイズを指定できます。
* `-z-stack:<n>` ... スタックサイズ(`<n>`はバイト数)
* `-z-heap:<n>` ... ヒープサイズ(`<n>`はバイト数)

XCとは異なり、アセンブラソースファイルやオブジェクトファイルにサイズ指定の情報は出力されません。

リンカ(hlk)実行時にリンカのオプションとして情報が渡されます。
* `-d_STACK_SIZE=<x>` ... スタックサイズ(`<x>`はバイト数の16進数表記)
* `-d_HEAP_SIZE=<x>` ... ヒープサイズ(`<x>`はバイト数の16進数表記)

定数シンボルとして`_STACK_SIZE`や`_HEAP_SIZE`が定義されるので、CLIB.L内の
\_DEDFSTK.Oや\_DEDFHEAP.Oはリンクされず、シンボルの値が使用されます。


### リンカを直接実行する場合のスタックとヒープサイズの指定

コンパイルにのみGCCを使い、オブジェクトファイルから実行ファイルを
生成するのにリンカを直接実行したいという状況になることもあります。

このような場合は、前述の`-d_STACK_SIZE=<x>`や`-d_HEAP_SIZE=<x>`オプションを
自分で渡すことでスタックサイズ、ヒープサイズを指定できます。


## LIBCでスタックとヒープサイズを指定する仕組み

LIBCはライブラリのオブジェクトファイルの構成や内部の構造はXCと異なりますが、
XCとの互換性が考慮されておりスタックサイズやヒープサイズもXCと同じ方法で指定できます。

ただしコンパイラはGCCを使うのが基本となるため、具体的な手順もGCC用のやり方になります。

参考：当該部分のソースコード
* [_start.c](https://github.com/kg68k/libc-src/blob/main/src/startup/_start.c)
  ... スタートアップルーチン。
* [_stackdef.s](https://github.com/kg68k/libc-src/blob/main/src/startup/_stackdef.s)
  ... `_STACK_SIZE`が指定されなかった場合の既定の定義。
* [_stacksiz.s](https://github.com/kg68k/libc-src/blob/main/src/startup/_stacksiz.s)
  ... `_STACK_SIZE`の値を保持する変数。
* [_heapdef.s](https://github.com/kg68k/libc-src/blob/main/src/startup/_heapdef.s)
  ... `_HEAP_SIZE`が指定されなかった場合の既定の定義。
* [_heapsiz.s](https://github.com/kg68k/libc-src/blob/main/src/startup/_heapsiz.s)
  ... `_HEAP_SIZE`の値を保持する変数。


### (LIBC) ファイル実行時のスタックとヒープサイズの指定

LIBCがリンクされた実行ファイルは、実行時にコマンドライン引数でオプションを
指定すればスタックサイズ、ヒープサイズを指定できます。
* `-+-s:<n>` ... スタックサイズ(`<n>`はバイト数)
* `-+-h:<n>` ... ヒープサイズ(`<n>`はバイト数)

余談：LIBCのスタートアップルーチンには、ほかに`-+-p`、`-+-f`、`-+-g`オプションもあります。


----
goto [index](../README.md) / [プログラミング](./README.md)
